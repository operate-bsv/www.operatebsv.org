(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{617:function(t,a,e){"use strict";e.r(a);var s=e(41),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("Transactions powered by Operate can be made to return any kind of value - from primitives like strings and integers, to arrays and "),e("RouterLink",{attrs:{to:"/blog/data-mapping-structured-objects/"}},[t._v("structured objects")]),t._v(". One little known superpower of Ops is that they can also return "),e("strong",[t._v("functions")]),t._v(".")],1),t._v(" "),e("p",[t._v("Returning a function allows you to create new, innovative ways of your application interfacing with Bitcoin. We can begin to treat transactions as interactive objects with methods and callbacks, and design transactions to do just about anything imaginable.")]),t._v(" "),e("p",[t._v("You can create transactions that are able to execute HTTP requests, or transactions that can build and broadcast new transactions. You can pass parameters directly from your application and implement some of your app's business logic inside transactions.")]),t._v(" "),e("h2",{attrs:{id:"handling-encrypted-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#handling-encrypted-data"}},[t._v("#")]),t._v(" Handling encrypted data")]),t._v(" "),e("p",[t._v("One use-case for functions is to create an interface for decrypting encrypted data. You can securely pass a private key from your application to a function, without permanently exposing the private key to the Lua VM or any other Ops in the program.")]),t._v(" "),e("p",[t._v("A number of Ops currently follow this pattern.")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"/library/op/?ref=714e3702"}},[e("code",[t._v("crypto/ecies_data")])]),t._v(" - puts data encrypted using Electrum's ECIES implementation on to the state.")]),t._v(" "),e("li",[e("a",{attrs:{href:"/library/op/?ref=49b32fbe"}},[e("code",[t._v("crypto/rsa_aes_data")])]),t._v(" - as above but uses an RSA/AES encryption algorithm.")])]),t._v(" "),e("p",[t._v("Both of these Ops attach a "),e("code",[t._v("decrypt")]),t._v(" function to the state, which can be called from your application. When passed the correct private key, the function handles decryption and returns the unencrypted data.")]),t._v(" "),e("p",[t._v("For example, the Op "),e("code",[t._v("crypto/ecies_data")]),t._v(" expects two parameters: the "),e("code",[t._v("path")]),t._v(" and the encrypted "),e("code",[t._v("data")]),t._v(". From the "),e("a",{attrs:{href:"/library/op/?ref=714e3702"}},[t._v("source code")]),t._v(", lets take a closer look at the following key parts.")]),t._v(" "),e("div",{staticClass:"language-lua extra-class"},[e("pre",{pre:!0,attrs:{class:"language-lua"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Define the encrypted data table")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" encrypted "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  data "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Attach the decrypt method")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" encrypted"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("decrypt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privatekey"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" crypto"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ecies"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("decrypt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("encrypted"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" privatekey"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n  \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Put the encrypted data on to state")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("extend")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encrypted"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" state\n")])])]),e("p",[t._v("The first part of the code above simply defines a local variable with the variable name "),e("code",[t._v("encrypted")]),t._v(", which is a table (like a JavaScript object) with a property containing the raw encrypted data.")]),t._v(" "),e("p",[t._v("The next few lines attach a function named "),e("code",[t._v("decrypt")]),t._v(" on the "),e("code",[t._v("encrypted")]),t._v(" table. This function receives a private key, handles decryption and returns the unencrypted data.")]),t._v(" "),e("p",[t._v("Finally the "),e("code",[t._v("encrypted")]),t._v(" table is added on to the state at the given "),e("code",[t._v("path")]),t._v(" and the state is returned.")]),t._v(" "),e("h2",{attrs:{id:"example-on-chain-paywall"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#example-on-chain-paywall"}},[t._v("#")]),t._v(" Example: On-chain paywall")]),t._v(" "),e("p",[t._v("Imagine you're building an on-chain paywall application. You want to design a transaction where part of the data is public and part encrypted. Your app holds the private key and controls access to the encrypted data to users who have paid a fee.")]),t._v(" "),e("p",[t._v("To construct the paywall transaction, you can use the Bitcom "),e("a",{attrs:{href:"https://b.bitdb.network",target:"_blank",rel:"noopener"}},[t._v("B://"),e("OutboundLink")],1),t._v(" protocol combined with the "),e("code",[t._v("crypto/ecies_data")]),t._v(" Op.")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("OP_FALSE OP_RETURN\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut"')]),t._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# B://")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello world"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Text/plain"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  0x714E3702  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# crypto/ecies_data")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"paywall"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("encrypted data"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("p",[t._v("Using the "),e("code",[t._v("bsv.js")]),t._v(" library, you can encrypt the paywall content using your app's public key. The following code will return the encrypted data to use in the transaction above.")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ECIES")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bsv/ecies'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ecies "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ECIES")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("publicKey")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pubkey"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" paywall "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Top secret information'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" encrypted "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ecies"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("encrypt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("paywall"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("When the transaction is run through Operate it will return an object like this:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello world"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"encoding"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"utf8"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text/plain"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"paywall"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"QklFMQNgUeoXx8LHV4rEbTzUJ9vjTGgKQ+8hZQq6Q5HpD77KReAHK0OS2nkh6BmWULqWWjN88O5vchd3ZEHvdXHzGPc0tsJaD67KGi/np47BLKPyyoBCSpGmuY3+SQcsMvX5S0c="')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"decrypt"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"function(privateKey)"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("Within your application you can now load and run the tape. The result gives you access to the "),e("code",[t._v("decrypt")]),t._v(" function, which you can call and pass your app's private key, and receive the decrypted data.")]),t._v(" "),e("div",{staticClass:"language-elixir extra-class"},[e("pre",{pre:!0,attrs:{class:"language-elixir"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Load and run the tape")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token atom symbol"}},[t._v(":ok")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tape"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" txid\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|>")]),t._v(" Operate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load_tape!\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|>")]),t._v(" Operate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run_tape\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Access and execute the decrypt function")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token atom symbol"}},[t._v(":ok")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tape"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("result\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|>")]),t._v(" get_in"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"paywall"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"decrypt"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|>")]),t._v(" Operate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("VM"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exec_function"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("private_key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("h2",{attrs:{id:"conclusion"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[t._v("#")]),t._v(" Conclusion")]),t._v(" "),e("p",[t._v("Functions returning functions is some crazy meta stuff! Suddenly your app's transactions no longer need be limited to containing static data, but can become living, breathing parts of your application. The line between where Bitcoin ends and your application starts can be wherever you decide that line to be. This opens the door to all kinds of creative use-cases.")]),t._v(" "),e("p",[t._v("In this article we're beginning to realize Operate's promise of "),e("em",[t._v("limitless possibilities")]),t._v(". In my next article we'll take this one step further and explore how we can extend the Lua VM, and make modules and functions from your application available to your Ops and transactions.")])])}),[],!1,null,null,null);a.default=n.exports}}]);